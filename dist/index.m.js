import{EventEmitter as t}from"eventemitter3";import{Room as e,RoomEvent as n,Track as o,RemoteAudioTrack as i,createAudioAnalyser as a}from"livekit-client";function r(t,e){return r=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},r(t,e)}try{(0,require("@livekit/react-native").registerGlobals)()}catch(t){console.warn("Failed to register LiveKit globals:",t)}var c=function(t){return"undefined"!=typeof window&&window.requestAnimationFrame?window.requestAnimationFrame(t):setTimeout(t,16)},s=new TextDecoder,l=/*#__PURE__*/function(t){function l(){var e;return(e=t.call(this)||this).room=void 0,e.connected=!1,e.isAgentTalking=!1,e.analyzerComponent=void 0,e.captureAudioFrame=void 0,e}var u,d;d=t,(u=l).prototype=Object.create(d.prototype),u.prototype.constructor=u,r(u,d);var m=l.prototype;return m.startCall=function(t){try{var n=this,o=function(o,i){try{var a=(n.room=new e({audioCaptureDefaults:{autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0,channelCount:1,deviceId:t.captureDeviceId,sampleRate:t.sampleRate},audioOutput:{deviceId:t.playbackDeviceId}}),n.handleRoomEvents(),n.handleAudioEvents(t),n.handleDataEvents(),Promise.resolve(n.room.connect("wss://retell-ai-4ihahnq7.livekit.cloud",t.accessToken)).then(function(){console.log("connected to room",n.room.name),n.room.localParticipant.setMicrophoneEnabled(!0),n.connected=!0,n.emit("call_started")}))}catch(t){return i(t)}return a&&a.then?a.then(void 0,i):a}(0,function(t){n.emit("error","Error starting call"),console.error("Error starting call",t),n.stopCall()});return Promise.resolve(o&&o.then?o.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},m.startAudioPlayback=function(){try{return Promise.resolve(this.room.startAudio()).then(function(){})}catch(t){return Promise.reject(t)}},m.stopCall=function(){var t,e;this.connected&&(this.connected=!1,this.emit("call_ended"),null==(t=this.room)||t.disconnect(),this.isAgentTalking=!1,delete this.room,this.analyzerComponent&&(this.analyzerComponent.cleanup(),delete this.analyzerComponent),this.captureAudioFrame&&(e=this.captureAudioFrame,"undefined"!=typeof window&&window.cancelAnimationFrame?window.cancelAnimationFrame(e):clearTimeout(e),delete this.captureAudioFrame))},m.mute=function(){this.connected&&this.room.localParticipant.setMicrophoneEnabled(!1)},m.unmute=function(){this.connected&&this.room.localParticipant.setMicrophoneEnabled(!0)},m.captureAudioSamples=function(){var t=this;if(this.connected&&this.analyzerComponent){var e=new Float32Array(this.analyzerComponent.analyser.fftSize);this.analyzerComponent.analyser.getFloatTimeDomainData(e),this.emit("audio",e),this.captureAudioFrame=c(function(){return t.captureAudioSamples()})}},m.handleRoomEvents=function(){var t=this;this.room.on(n.ParticipantDisconnected,function(e){"server"===(null==e?void 0:e.identity)&&setTimeout(function(){t.stopCall()},500)}),this.room.on(n.Disconnected,function(){t.stopCall()})},m.handleAudioEvents=function(t){var e=this;this.room.on(n.TrackSubscribed,function(n,r,s){if(n.kind===o.Kind.Audio&&n instanceof i){if("agent_audio"===r.trackName&&(e.emit("call_ready"),t.emitRawAudioSamples))try{e.analyzerComponent=a(n),e.captureAudioFrame=c(function(){return e.captureAudioSamples()})}catch(t){console.warn("Audio analysis not supported in React Native:",t)}n.attach()}})},m.handleDataEvents=function(){var t=this;this.room.on(n.DataReceived,function(e,n,o,i){try{if("server"!==(null==n?void 0:n.identity))return;var a=s.decode(e),r=JSON.parse(a);"update"===r.event_type?t.emit("update",r):"metadata"===r.event_type?t.emit("metadata",r):"agent_start_talking"===r.event_type?(t.isAgentTalking=!0,t.emit("agent_start_talking")):"agent_stop_talking"===r.event_type?(t.isAgentTalking=!1,t.emit("agent_stop_talking")):"node_transition"===r.event_type&&t.emit("node_transition",r)}catch(t){console.error("Error decoding data received",t)}})},l}(t);export{l as RetellWebClient,l as default};
