import{registerGlobals as t}from"@livekit/react-native";import{EventEmitter as e}from"eventemitter3";import{Room as n,RoomEvent as o,Track as i,RemoteAudioTrack as a,createAudioAnalyser as r}from"livekit-client";function c(t,e){return c=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},c(t,e)}var s=function(t){return"undefined"!=typeof window&&window.requestAnimationFrame?window.requestAnimationFrame(t):setTimeout(t,16)},l=new TextDecoder;try{t()}catch(t){console.warn("Failed to register LiveKit globals:",t)}var u=/*#__PURE__*/function(t){function e(){var e;return(e=t.call(this)||this).room=void 0,e.connected=!1,e.isAgentTalking=!1,e.analyzerComponent=void 0,e.captureAudioFrame=void 0,e}var u,d;d=t,(u=e).prototype=Object.create(d.prototype),u.prototype.constructor=u,c(u,d);var m=e.prototype;return m.startCall=function(t){try{var e=this,o=function(o,i){try{var a=(e.room=new n({audioCaptureDefaults:{autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0,channelCount:1,deviceId:t.captureDeviceId,sampleRate:t.sampleRate},audioOutput:{deviceId:t.playbackDeviceId}}),e.handleRoomEvents(),e.handleAudioEvents(t),e.handleDataEvents(),Promise.resolve(e.room.connect("wss://retell-ai-4ihahnq7.livekit.cloud",t.accessToken)).then(function(){console.log("connected to room",e.room.name),e.room.localParticipant.setMicrophoneEnabled(!0),e.connected=!0,e.emit("call_started")}))}catch(t){return i(t)}return a&&a.then?a.then(void 0,i):a}(0,function(t){e.emit("error","Error starting call"),console.error("Error starting call",t),e.stopCall()});return Promise.resolve(o&&o.then?o.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},m.startAudioPlayback=function(){try{return Promise.resolve(this.room.startAudio()).then(function(){})}catch(t){return Promise.reject(t)}},m.stopCall=function(){var t,e;this.connected&&(this.connected=!1,this.emit("call_ended"),null==(t=this.room)||t.disconnect(),this.isAgentTalking=!1,delete this.room,this.analyzerComponent&&(this.analyzerComponent.cleanup(),delete this.analyzerComponent),this.captureAudioFrame&&(e=this.captureAudioFrame,"undefined"!=typeof window&&window.cancelAnimationFrame?window.cancelAnimationFrame(e):clearTimeout(e),delete this.captureAudioFrame))},m.mute=function(){this.connected&&this.room.localParticipant.setMicrophoneEnabled(!1)},m.unmute=function(){this.connected&&this.room.localParticipant.setMicrophoneEnabled(!0)},m.captureAudioSamples=function(){var t=this;if(this.connected&&this.analyzerComponent){var e=new Float32Array(this.analyzerComponent.analyser.fftSize);this.analyzerComponent.analyser.getFloatTimeDomainData(e),this.emit("audio",e),this.captureAudioFrame=s(function(){return t.captureAudioSamples()})}},m.handleRoomEvents=function(){var t=this;this.room.on(o.ParticipantDisconnected,function(e){"server"===(null==e?void 0:e.identity)&&setTimeout(function(){t.stopCall()},500)}),this.room.on(o.Disconnected,function(){t.stopCall()})},m.handleAudioEvents=function(t){var e=this;this.room.on(o.TrackSubscribed,function(n,o,c){if(n.kind===i.Kind.Audio&&n instanceof a){if("agent_audio"===o.trackName&&(e.emit("call_ready"),t.emitRawAudioSamples))try{e.analyzerComponent=r(n),e.captureAudioFrame=s(function(){return e.captureAudioSamples()})}catch(t){console.warn("Audio analysis not supported in React Native:",t)}n.attach()}})},m.handleDataEvents=function(){var t=this;this.room.on(o.DataReceived,function(e,n,o,i){try{if("server"!==(null==n?void 0:n.identity))return;var a=l.decode(e),r=JSON.parse(a);"update"===r.event_type?t.emit("update",r):"metadata"===r.event_type?t.emit("metadata",r):"agent_start_talking"===r.event_type?(t.isAgentTalking=!0,t.emit("agent_start_talking")):"agent_stop_talking"===r.event_type?(t.isAgentTalking=!1,t.emit("agent_stop_talking")):"node_transition"===r.event_type&&t.emit("node_transition",r)}catch(t){console.error("Error decoding data received",t)}})},e}(e);export{u as RetellWebClient,u as default};
